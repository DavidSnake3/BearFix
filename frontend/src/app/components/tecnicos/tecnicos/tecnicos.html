<div class="tecnicos-container">
  <div class="tecnicos-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="page-title">
          <i class="bi bi-people"></i>
          {{'Gestión de Técnicos' | transloco}}
        </h1>
        <p class="page-subtitle">{{'Administracion de Tecnicos' | transloco}}</p>
      </div>

      <div class="header-actions">
        <button class="btn-action refresh" (click)="loadTecnicos()" [disabled]="isLoading()">
          <i class="bi" [ngClass]="isLoading() ? 'bi-arrow-clockwise spin' : 'bi-arrow-clockwise'"></i>
          {{ isLoading() ? ('Cargando...' | transloco) : ('Actualizar' | transloco) }}
        </button>
        <button class="btn-action primary" (click)="openCreateModal()">
          <i class="bi bi-plus-circle"></i>
          {{'Agregar Técnico' | transloco}}
        </button>
      </div>
    </div>
  </div>

  <div class="filters-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-funnel"></i>
        {{'Filtros' | transloco}}
      </h3>
    </div>
    <div class="card-body">
      <div class="filters-grid">

        <div class="filter-group">
          <label class="filter-label">{{'Buscar Técnico' | transloco}}</label>
          <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input type="text" class="form-input search-input large" placeholder="{{'Buscar por nombre o correo...' | transloco}}"
              [value]="searchInput()" (input)="onSearchChange($event)">
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">{{'Estado' | transloco}}</label>
          <select class="form-select" [value]="filtroDisponible()"
            (change)="onDisponibleChange($any($event.target).value)">
            <option value="">{{'Todos los estados' | transloco}}</option>
            <option value="true">{{'Disponible' | transloco}}</option>
            <option value="false">{{'No disponible' | transloco}}</option>
          </select>
        </div>
      </div>

      @if (searchInput() || filtroDisponible()) {
      <div class="active-filters">
        <span class="filters-label">{{'Filtros activos:' | transloco}}</span>
        @if (searchInput()) {
        <span class="filter-badge">
          {{'Búsqueda:' | transloco}} "{{ searchInput() }}"
          <i class="bi bi-x" (click)="onSearchChange({ target: { value: '' } })"></i>
        </span>
        }
        @if (filtroDisponible() === 'true') {
        <span class="filter-badge">
          {{'Estado: Disponible' | transloco}}
          <i class="bi bi-x" (click)="onDisponibleChange('')"></i>
        </span>
        }
        @if (filtroDisponible() === 'false') {
        <span class="filter-badge">
          {{'Estado: No disponible' | transloco}}
          <i class="bi bi-x" (click)="onDisponibleChange('')"></i>
        </span>
        }
      </div>
      }
    </div>
  </div>

  <div class="main-card">
    <div class="card-header">
      <div class="card-header-content">
        <div>
          <h2 class="card-title">
            <i class="bi bi-list-ul"></i>
            {{'Lista de Técnicos' | transloco}}
          </h2>
          <p class="card-subtitle">
            {{'Mostrando' | transloco}} {{ tecnicos().length }} {{'de' | transloco}} {{ paginacion().totalItems }} {{'técnicos' | transloco}}
          </p>
        </div>
        <div class="header-controls">
          <div class="items-per-page">
            <label>{{'Mostrar:' | transloco}}</label>
            <select class="form-select small" [value]="paginacion().itemsPerPage"
              (change)="cambiarItemsPorPagina($any($event.target).value)">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body">
      @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner-container">
          <div class="spinner"></div>
          <p>{{'Cargando técnicos...' | transloco}}</p>
        </div>
      </div>
      } @else {
      @if (tecnicos().length > 0) {
      <div class="table-container">
        <table class="modern-table">
          <thead class="table-header">
            <tr>
              <th scope="col" class="ps-4">{{'Técnico' | transloco}}</th>
              <th scope="col">{{'Contacto' | transloco}}</th>
              <th scope="col">{{'Estado' | transloco}}</th>
              <th scope="col" class="text-center pe-4">{{'Acciones' | transloco}}</th>
            </tr>
          </thead>
          <tbody>
            @for (tecnico of tecnicos(); track tecnico.id) {
            <tr class="table-row">
              <td class="ps-4">
                <div class="tecnico-info">
                  <div class="tecnico-avatar">
                    <i class="fas fa-user"></i>
                  </div>
                  <div class="tecnico-details">
                    <div class="tecnico-name">{{ tecnico.nombre }}</div>
                   
                  </div>
                </div>
              </td>

              <td>
                <div class="contact-info">
                  <div class="contact-item">
                    <i class="bi bi-envelope"></i>
                    <span class="contact-value">{{ tecnico.correo }}</span>
                  </div>
                  <div class="contact-item">
                    <i class="bi bi-telephone"></i>
                    <span class="contact-value">{{ tecnico.telefono || ('Sin teléfono' | transloco) }}</span>
                  </div>
                </div>
              </td>

              <td>
                <span class="badge" [ngClass]="tecnico.disponible ? 'bg-success' : 'bg-secondary'">
                  <i class="bi me-1" [ngClass]="tecnico.disponible ? 'bi-check-circle' : 'bi-x-circle'"></i>
                  {{ tecnico.disponible ? ('Disponible' | transloco) : ('No disponible' | transloco) }}
                </span>
              </td>

              <td class="text-center pe-4">
                <div class="action-buttons">
                  <button class="btn-icon info" (click)="viewTecnicoDetail(tecnico)" title="{{'Ver detalle' | transloco}}">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn-icon warning" (click)="enableEditMode(tecnico)" title="{{'Editar técnico' | transloco}}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-icon danger" (click)="deleteTecnico(tecnico)" title="{{'Eliminar técnico' | transloco}}">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="pagination-container">
        <div class="pagination-info">
          {{'Página' | transloco}} {{ paginacion().currentPage }} {{'de' | transloco}} {{ paginacion().totalPages }} •
          {{ paginacion().totalItems }} {{'técnicos en total' | transloco}}
        </div>
        <nav class="pagination">
          <button class="pagination-btn" [disabled]="!paginacion().hasPrevPage"
            (click)="cambiarPagina(paginacion().currentPage - 1)">
            <i class="bi bi-chevron-left"></i> {{'Anterior' | transloco}}
          </button>

          <div class="pagination-pages">
            @for (page of getPaginationPages(); track page) {
            @if (page === '...') {
            <span class="pagination-ellipsis">...</span>
            } @else {
            <button class="pagination-page" [class.active]="page === paginacion().currentPage"
              (click)="cambiarPagina(page)">
              {{ page }}
            </button>
            }
            }
          </div>

          <button class="pagination-btn" [disabled]="!paginacion().hasNextPage"
            (click)="cambiarPagina(paginacion().currentPage + 1)">
            {{'Siguiente' | transloco}} <i class="bi bi-chevron-right"></i>
          </button>
        </nav>
      </div>

      } @else {
      <div class="empty-state">
        <div class="empty-content">
          <i class="bi bi-people empty-icon"></i>
          <h3>{{'No se encontraron técnicos' | transloco}}</h3>
          <p>
            {{'No hay técnicos que coincidan con los filtros aplicados.' | transloco}}
            @if (searchInput() || filtroDisponible()) {
            <br>
            <small>{{'Intenta ajustar los filtros de búsqueda.' | transloco}}</small>
            }
          </p>
          <button class="btn-action primary" (click)="limpiarFiltros()">
            <i class="bi bi-arrow-clockwise"></i>
            {{'Limpiar Filtros' | transloco}}
          </button>
        </div>
      </div>
      }
      }
    </div>
  </div>
</div>

<!-- Modal para detalle/edición -->
@if (showModal()) {
<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header" [ngClass]="isEditing() ? 'editing' : 'viewing'">
      <div class="modal-title">
        <i class="bi" [ngClass]="isEditing() ? 'bi-pencil-square' : 'bi-person-badge'"></i>
        <div>
          <h3>{{ isEditing() ? ('Editando Técnico' | transloco) : ('Detalle del Técnico' | transloco) }}</h3>
        </div>
      </div>
      <button class="btn-close" (click)="isEditing() ? cancelEdit() : closeModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    @if (selectedTecnico()) {
    <div class="modal-body">
      <div class="tecnico-header">
        <div class="tecnico-avatar-large">
          <i class="bi bi-person-fill"></i>
        </div>

        @if (!isEditing()) {
        <div class="tecnico-info">
          <h2>{{ selectedTecnico()!.nombre }}</h2>
        </div>
        <div class="tecnico-meta-row">
          <span class="tecnico-id">ID: {{ selectedTecnico()!.id }}</span>
          <span class="badge" [ngClass]="selectedTecnico()!.disponible ? 'bg-success' : 'bg-secondary'">
            <i class="bi me-1" [ngClass]="selectedTecnico()!.disponible ? 'bi-check-circle' : 'bi-x-circle'"></i>
            {{ selectedTecnico()!.disponible ? ('Disponible' | transloco) : ('No disponible' | transloco) }}
          </span>
        </div>
        } @else {
        <div class="tecnico-edit">
          <div class="edit-fields">
            <input type="text" class="form-input large" [(ngModel)]="editTecnicoData().nombre"
              placeholder="Nombre del técnico">
            <div class="edit-selectors">
              <select class="form-select" [(ngModel)]="editTecnicoData().disponible">
                <option [ngValue]="true">{{'Disponible' | transloco}}</option>
                <option [ngValue]="false">{{'No disponible' | transloco}}</option>
              </select>
            </div>
          </div>
        </div>
        }
      </div>

      <div class="modal-grid">
        <div class="modal-section">
          <div class="section-card equal-height">
            <div class="section-header">
              <i class="bi bi-info-circle"></i>
              <h4>{{'Información Básica' | transloco}}</h4>
            </div>
            <div class="section-body">
              @if (!isEditing()) {
              <div class="info-grid">
                <div class="info-row">
                  <div class="info-item">
                    <label>{{'Correo Electrónico' | transloco}}</label>
                    <div class="info-value">
                      <i class="bi bi-envelope"></i>
                      <span>{{ selectedTecnico()!.correo }}</span>
                    </div>
                  </div>
                  <div class="info-item">
                    <label>{{'Teléfono' | transloco}}</label>
                    <div class="info-value">
                      <i class="bi bi-telephone"></i>
                      <span>{{ selectedTecnico()!.telefono || 'No registrado' }}</span>
                    </div>
                  </div>
                </div>
                <div class="info-row">
                  <div class="info-item">
                    <label>{{'Fecha de Registro' | transloco}}</label>
                    <div class="info-value">
                      <i class="bi bi-calendar"></i>
                      <span>{{ selectedTecnico()!.creadoEn | date:'dd/MM/yyyy' }}</span>
                    </div>
                  </div>
                  <div class="info-item">
                    <label>{{'Última Actualización' | transloco}}</label>
                    <div class="info-value">
                      <i class="bi bi-clock"></i>
                      <span>{{ selectedTecnico()!.actualizadoEn | date:'dd/MM/yyyy' }}</span>
                    </div>
                  </div>
                </div>
              </div>
              } @else {
              <div class="edit-grid">
                <div class="form-group">
                  <label class="form-label">{{'Correo Electrónico' | transloco}}</label>
                  <div class="input-with-icon">
                    <i class="bi bi-envelope"></i>
                    <input type="email" class="form-input" [(ngModel)]="editTecnicoData().correo">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">{{'Teléfono' | transloco}}</label>
                  <div class="input-with-icon">
                    <i class="bi bi-telephone"></i>
                    <input type="tel" class="form-input" [(ngModel)]="editTecnicoData().telefono">
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
        </div>

        <div class="modal-section">
          <div class="section-card equal-height">
            <div class="section-header">
              <i class="bi bi-graph-up"></i>
              <h4>{{'Carga de Trabajo' | transloco}}</h4>
            </div>
            <div class="section-body">
              <div class="workload-grid">
                <div class="workload-row">
                  <div class="workload-item">
                    <label>{{'Tiquetes Asignados' | transloco}}</label>
                    <div class="workload-content">
                      <div class="workload-stats">
                        <span class="workload-current">{{ selectedTecnico()!.cargaTrabajo || 0 }}</span>
                        <span class="workload-separator">/</span>
                        <span class="workload-limit">{{ selectedTecnico()!.limiteCargaTickets || 'N/A' }}</span>
                      </div>
                    </div>
                    @if (selectedTecnico()!.limiteCargaTickets && selectedTecnico()!.cargaTrabajo !== undefined) {
                    <div class="progress-container">
                      <div class="progress-bar"
                        [ngClass]="getWorkloadClass(selectedTecnico()!.cargaTrabajo, selectedTecnico()!.limiteCargaTickets)"
                        [style.width]="getWorkloadPercentage(selectedTecnico()!.cargaTrabajo, selectedTecnico()!.limiteCargaTickets) + '%'">
                        <span class="progress-text">
                          {{ getWorkloadPercentage(selectedTecnico()!.cargaTrabajo,
                          selectedTecnico()!.limiteCargaTickets)
                          }}%
                        </span>
                      </div>
                    </div>
                    }
                  </div>
                </div>
                <div class="workload-row workload-items-row">
                  <div class="workload-item">
                    <label>{{'Cargos Actuales' | transloco}}</label>
                    <div class="info-value">
                      <i class="bi bi-briefcase"></i>
                      <span>{{ selectedTecnico()!.cargosActuales || 0 }}</span>
                    </div>
                  </div>
                  <div class="workload-item">
                    <label>{{'Límite de Tiquetes' | transloco}}</label>
                    <div class="info-value">
                      <i class="bi bi-clipboard-check"></i>
                      <span>{{ selectedTecnico()!.limiteCargaTickets || 'No definido' }}</span>
                    </div>
                  </div>
                </div>
              </div>

              @if (isEditing()) {
              <div class="form-group">
                <label class="form-label">{{'Límite de Tiquetes' | transloco}}</label>
                <div class="input-with-icon">
                  <i class="bi bi-clipboard-check"></i>
                  <input type="number" class="form-input" [(ngModel)]="editTecnicoData().limiteCargaTickets">
                </div>
              </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de Especialidades en Edición -->
      @if (isEditing()) {
      <div class="modal-section">
        <div class="section-card">
          <div class="section-header">
            <i class="bi bi-award"></i>
            <h4>{{'Especialidades' | transloco}}</h4>
            <button class="btn-action primary small" (click)="openEspecialidadesModal(false)">
              <i class="bi bi-plus-circle"></i>
              {{'Gestionar Especialidades' | transloco}}
            </button>
          </div>
          <div class="section-body">
            @if (editTecnicoData().especialidades && editTecnicoData().especialidades.length > 0) {
            <div class="especialidades-tags">
              @for (espId of editTecnicoData().especialidades; track espId) {
              <div class="especialidad-tag">
                <span class="tag-text">{{ getEspecialidadNombre(espId) }}</span>
                <button class="tag-remove" (click)="removeEspecialidad(espId, false)">
                  <i class="bi bi-x"></i>
                </button>
              </div>
              }
            </div>
            } @else {
            <div class="empty-especialidades">
              <i class="bi bi-award"></i>
              <p>{{'No hay especialidades asignadas' | transloco}}</p>
            </div>
            }
          </div>
        </div>
      </div>
      } @else {
        <!-- Mostrar especialidades en modo visualización -->
        @if (selectedTecnico()!.usuarioEspecialidades && selectedTecnico()!.usuarioEspecialidades.length > 0) {
        <div class="modal-section">
          <div class="section-card">
            <div class="section-header">
              <i class="bi bi-award"></i>
              <h4>{{'Especialidades' | transloco}}</h4>
              <span class="section-badge">{{ selectedTecnico()!.usuarioEspecialidades.length }}</span>
            </div>
            <div class="section-body">
              <div class="specialties-grid">
                @for (esp of selectedTecnico()!.usuarioEspecialidades; track esp.especialidadId) {
                <div class="specialty-card">
                  <div class="specialty-header">
                    <h5>{{ esp.especialidad?.nombre || ('Sin nombre' | transloco) }}</h5>
                  </div>
                  <p class="specialty-description">{{ esp.especialidad?.descripcion || 'Sin descripción' }}</p>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
        }
      }

      @if (selectedTecnico()!.asignacionesRecibidas && selectedTecnico()!.asignacionesRecibidas.length > 0) {
      <div class="modal-section">
        <div class="section-card">
          <div class="section-header">
            <i class="bi bi-ticket-perforated"></i>
            <h4>{{'Tickets Asignados' | transloco}}</h4>
            <span class="section-badge">{{ selectedTecnico()!.asignacionesRecibidas.length }}</span>
          </div>
          <div class="section-body">
            <div class="tickets-table">
              <div class="table-header-row">
                <div class="table-cell">{{'Tiquete' | transloco}}</div>
                <div class="table-cell">{{'Descripcion' | transloco}}</div>
                <div class="table-cell">{{'Estado' | transloco}}</div>
                <div class="table-cell">{{'Prioridad' | transloco}}</div>
                <div class="table-cell">{{'Fecha Asignación' | transloco}}</div>
              </div>
              <div class="table-body">
                @for (asignacion of selectedTecnico()!.asignacionesRecibidas; track asignacion.id) {
                <div class="table-row2">
                  <div class="table-cell">
                    <strong class="ticket-code">{{ asignacion.ticket?.consecutivo || 'N/A' }}</strong>
                  </div>
                  <div class="table-cell ticket-title">
                    {{ asignacion.ticket?.titulo || ('Sin título' | transloco) }}
                  </div>
                  <div class="table-cell">
                    <span class="badge" [ngClass]="getEstadoBadgeClass(asignacion.ticket?.estado || '')">
                      {{ asignacion.ticket?.estado || 'N/A' }}
                    </span>
                  </div>
                  <div class="table-cell">
                    <span class="badge" [ngClass]="getPrioridadBadgeClass(asignacion.ticket?.prioridad || '')">
                      {{ asignacion.ticket?.prioridad || 'N/A' }}
                    </span>
                  </div>
                  <div class="table-cell">
                    <small class="text-muted">{{ asignacion.fechaAsignacion | date:'dd/MM/yyyy' }}</small>
                  </div>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      }

      @if ((!selectedTecnico()!.usuarioEspecialidades || selectedTecnico()!.usuarioEspecialidades.length === 0) &&
      !isEditing()) {
      <div class="empty-section">
        <i class="bi bi-award"></i>
        <p>{{'No hay especialidades registradas' | transloco}}</p>
      </div>
      }

      @if ((!selectedTecnico()!.asignacionesRecibidas || selectedTecnico()!.asignacionesRecibidas.length === 0) &&
      !isEditing()) {
      <div class="empty-section">
        <i class="bi bi-inbox"></i>
        <p>{{'No hay tiquetes asignados' | transloco}}</p>
      </div>
      }
    </div>
    }

    <div class="modal-footer">
      <button type="button" class="btn-action secondary" (click)="isEditing() ? cancelEdit() : closeModal()">
        <i class="bi bi-x-circle"></i>
        {{ isEditing() ? ('Cancelar' | transloco) : ('Cerrar' | transloco) }}
      </button>

      @if (!isEditing()) {
      <button type="button" class="btn-action primary" (click)="enableEdit()">
        <i class="bi bi-pencil"></i>
        {{'Editar Técnico' | transloco}}
      </button>
      }

      @if (isEditing()) {
      <button type="button" class="btn-action success" (click)="saveTecnico()">
        <i class="bi bi-check-circle"></i>
        {{'Guardar Cambios' | transloco}}
      </button>
      }
    </div>
  </div>
</div>
}

<!-- Modal para crear técnico -->
@if (showCreateModal()) {
<div class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header editing">
      <div class="modal-title">
        <i class="bi bi-person-plus"></i>
        <div>
          <h3>{{'Crear Nuevo Técnico' | transloco}}</h3>
        </div>
      </div>
      <button class="btn-close" (click)="closeCreateModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="tecnico-header">
        <div class="tecnico-avatar-large">
          <i class="bi bi-person-fill"></i>
        </div>
        <div class="tecnico-edit">
          <div class="edit-fields">
            <input type="text" class="form-input large" [(ngModel)]="newTecnico().nombre"
              placeholder="Nombre del técnico">
            <div class="edit-selectors">
              <select class="form-select" [(ngModel)]="newTecnico().disponible">
                <option [ngValue]="true">{{'Disponible' | transloco}}</option>
                <option [ngValue]="false">{{'No disponible' | transloco}}</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-grid">
        <div class="modal-section">
          <div class="section-card equal-height">
            <div class="section-header">
              <i class="bi bi-info-circle"></i>
              <h4>{{'Información Básica' | transloco}}</h4>
            </div>
            <div class="section-body">
              <div class="edit-grid">
                <div class="form-group">
                  <label class="form-label">{{'Correo Electrónico *' | transloco}}</label>
                  <div class="input-with-icon">
                    <i class="bi bi-envelope"></i>
                    <input type="email" class="form-input" [(ngModel)]="newTecnico().correo" placeholder="tecnico@empresa.com">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">{{'Teléfono' | transloco}}</label>
                  <div class="input-with-icon">
                    <i class="bi bi-telephone"></i>
                    <input type="tel" class="form-input" [(ngModel)]="newTecnico().telefono" placeholder="+506 1234-5678">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-section">
          <div class="section-card equal-height">
            <div class="section-header">
              <i class="bi bi-graph-up"></i>
              <h4>{{'Carga de Trabajo' | transloco}}</h4>
            </div>
            <div class="section-body">
              <div class="form-group">
                <label class="form-label">{{'Límite de Tiquetes' | transloco}}</label>
                <div class="input-with-icon">
                  <i class="bi bi-clipboard-check"></i>
                  <input type="number" class="form-input" [(ngModel)]="newTecnico().limiteCargaTickets" min="1" max="20">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-section">
        <div class="section-card">
          <div class="section-header">
            <i class="bi bi-award"></i>
            <h4>{{'Especialidades' | transloco}}</h4>
            <button class="btn-action primary small" (click)="openEspecialidadesModal(true)">
              <i class="bi bi-plus-circle"></i>
              {{'Gestionar Especialidades' | transloco}}
            </button>
          </div>
          <div class="section-body">
            @if (newTecnico().especialidades?.length) {
            <div class="especialidades-tags">
              @for (espId of newTecnico().especialidades; track espId) {
              <div class="especialidad-tag">
                <span class="tag-text">{{ getEspecialidadNombre(espId) }}</span>
                <button class="tag-remove" (click)="removeEspecialidad(espId, true)">
                  <i class="bi bi-x"></i>
                </button>
              </div>
              }
            </div>
            } @else {
            <div class="empty-especialidades">
              <i class="bi bi-award"></i>
              <p>{{'No hay especialidades asignadas' | transloco}}</p>
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-action secondary" (click)="closeCreateModal()">
        <i class="bi bi-x-circle"></i>
        {{'Cancelar' | transloco}}
      </button>

      <button type="button" class="btn-action success" (click)="createTecnico()" [disabled]="isLoading()">
        <i class="bi bi-check-circle"></i>
        {{ isLoading() ? ('Creando...' | transloco) : ('Crear Técnico' | transloco) }}
      </button>
    </div>
  </div>
</div>
}

<!-- Modal para gestionar especialidades con pestañas COMPLETO -->
@if (showEspecialidadesModal()) {
<div class="modal-overlay" (click)="closeEspecialidadesModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header primary">
      <div class="modal-title">
        <i class="bi bi-award"></i>
        <div>
          <h3>{{'Gestionar Especialidades' | transloco}}</h3>
          <p class="modal-subtitle">{{'Selecciona o gestiona las especialidades del técnico' | transloco}}</p>
        </div>
      </div>
      <button class="btn-close" (click)="closeEspecialidadesModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="tabs-container">
      <div class="tabs-header">
        <button class="tab-button" [class.active]="especialidadesTabActive() === 'select'" 
                (click)="especialidadesTabActive.set('select')">
          {{'Seleccionar Especialidades' | transloco}}
        </button>
        <button class="tab-button" [class.active]="especialidadesTabActive() === 'manage'" 
                (click)="especialidadesTabActive.set('manage')">
          {{'Gestionar Especialidades' | transloco}}
        </button>
      </div>

      <div class="tab-content">
        <!-- Pestaña de selección -->
        <div class="tab-pane" [class.active]="especialidadesTabActive() === 'select'">
          <div class="modal-body">
            <div class="especialidades-search-container">
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" 
                       placeholder="Buscar especialidades..." 
                       [value]="especialidadesSearch()"
                       (input)="onEspecialidadSearchChange($event)">
              </div>
            </div>

            <div class="especialidades-list">
              @for (especialidad of especialidadesFiltradas(); track especialidad.id) {
              <div class="especialidad-item" [class.selected]="isEspecialidadSelected(especialidad.id!)"
                   (click)="addEspecialidad(especialidad)">
                <div class="especialidad-checkbox">
                  <div class="checkbox" [class.checked]="isEspecialidadSelected(especialidad.id!)">
                    <i class="bi bi-check"></i>
                  </div>
                </div>
                <div class="especialidad-info">
                  <h4>{{ especialidad.nombre }}</h4>
                  <p>{{ especialidad.descripcion || ('Sin descripción' | transloco) }}</p>
                  <span class="especialidad-codigo">{{ especialidad.codigo }}</span>
                </div>
              </div>
              }
              @if (especialidadesFiltradas().length === 0) {
              <div class="empty-especialidades">
                <i class="bi bi-search"></i>
                <p>{{'No se encontraron especialidades' | transloco}}</p>
              </div>
              }
            </div>
          </div>
        </div>

        <!-- Pestaña de gestión -->
        <div class="tab-pane" [class.active]="especialidadesTabActive() === 'manage'">
          <div class="modal-body">
            <div class="gestion-header">
              <h4>{{'Lista de Especialidades' | transloco}}</h4>
              <button class="btn-action primary small" (click)="openGestionEspecialidadModal()">
                <i class="bi bi-plus-circle"></i>
                {{'Agregar Especialidad' | transloco}}
              </button>
            </div>

            <div class="gestion-list">
              @for (especialidad of especialidadesList(); track especialidad.id) {
              <div class="gestion-item">
                <div class="gestion-item-info">
                  <h4>{{ especialidad.nombre }}</h4>
                  <p>{{ especialidad.descripcion || ('Sin descripción' | transloco) }}</p>
                  <span class="especialidad-codigo">{{ especialidad.codigo }}</span>
                </div>
                <div class="gestion-item-actions">
                  <button class="btn-icon warning" (click)="openGestionEspecialidadModal(especialidad)" title="(Editar especialidad | transloco)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-icon danger" (click)="eliminarEspecialidad(especialidad)" title="(Eliminar especialidad | transloco)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              }
              @if (especialidadesList().length === 0) {
              <div class="empty-especialidades">
                <i class="bi bi-award"></i>
                <p>{{'No hay especialidades creadas' | transloco}}</p>
              </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-action secondary" (click)="closeEspecialidadesModal()">
        <i class="bi bi-x-circle"></i>
        {{'Cerrar' | transloco}}
      </button>
      <button type="button" class="btn-action success" (click)="closeEspecialidadesModal()">
        <i class="bi bi-check-circle"></i>
        {{'Confirmar' | transloco}}
      </button>
    </div>
  </div>
</div>
}

<!-- Modal para gestión de especialidades (CREAR/EDITAR) -->
@if (showGestionEspecialidadModal()) {
<div class="modal-overlay" (click)="closeGestionEspecialidadModal()">
  <div class="modal-content medium" (click)="$event.stopPropagation()">
    <div class="modal-header primary">
      <div class="modal-title">
        <i class="bi bi-award"></i>
        <div>
          <h3>{{ especialidadEditando() ? ('Editar Especialidad' | transloco) : ('Crear Especialidad' | transloco) }}</h3>
        </div>
      </div>
      <button class="btn-close" (click)="closeGestionEspecialidadModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-container">
        <div class="form-group">
          <label class="form-label">{{'Código *' | transloco}}</label>
          <input type="text" class="form-input" [(ngModel)]="nuevaEspecialidad().codigo" placeholder="Código de la especialidad">
        </div>

        <div class="form-group">
          <label class="form-label">{{'Nombre *' | transloco}}</label>
          <input type="text" class="form-input" [(ngModel)]="nuevaEspecialidad().nombre" placeholder="Nombre de la especialidad">
        </div>

        <div class="form-group">
          <label class="form-label">{{'Descripción' | transloco}}</label>
          <textarea class="form-textarea" rows="3" [(ngModel)]="nuevaEspecialidad().descripcion" placeholder="Descripción de la especialidad"></textarea>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-action secondary" (click)="closeGestionEspecialidadModal()">
        <i class="bi bi-x-circle"></i>
        Cancelar
      </button>

      @if (especialidadEditando()) {
      <button type="button" class="btn-action success" (click)="actualizarEspecialidad()" [disabled]="isLoading()">
        <i class="bi bi-check-circle"></i>
        {{ isLoading() ? 'Actualizando...' : 'Actualizar Especialidad' }}
      </button>
      } @else {
      <button type="button" class="btn-action success" (click)="crearEspecialidad()" [disabled]="isLoading()">
        <i class="bi bi-check-circle"></i>
        {{ isLoading() ? 'Creando...' : 'Crear Especialidad' }}
      </button>
      }
    </div>
  </div>
</div>
}

<!-- Spinner global -->
@if (isLoading()) {
<div class="global-spinner-overlay">
  <div class="spinner-container">
    <div class="spinner"></div>
    <p>Procesando...</p>
  </div>
</div>
}