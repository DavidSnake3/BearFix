<div class="tickets-container">
  <div class="tickets-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="page-title">
          <i class="bi bi-clock-history"></i>
          Mis Tickets
        </h1>
        <p class="page-subtitle">Historial de todos los tickets que has creado en el sistema</p>
      </div>

      <div class="header-actions">
        <button class="btn-action refresh" (click)="loadTickets()" [disabled]="isLoading()">
          <i class="bi" [ngClass]="isLoading() ? 'bi-arrow-clockwise spin' : 'bi-arrow-clockwise'"></i>
          {{ isLoading() ? 'Cargando...' : 'Actualizar' }}
        </button>
      </div>
    </div>
  </div>

  <div class="filters-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-funnel"></i>
        Filtros
      </h3>
    </div>
    <div class="card-body">
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Buscar Ticket</label>
          <div class="search-container full-width">
            <i class="bi bi-search search-icon"></i>
            <input 
              type="text" 
              class="form-input search-input large" 
              placeholder="Buscar por consecutivo o título..." 
              [value]="searchInput()"
              (input)="onSearchChange($event)">
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">Estado</label>
          <select class="form-select" 
                  [value]="filtros().estado"
                  (change)="aplicarFiltro('estado', $any($event.target).value)">
            <option value="">Todos los estados</option>
            @for (estado of estados(); track estado) {
              <option [value]="estado">{{ estado }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Prioridad</label>
          <select class="form-select" 
                  [value]="filtros().prioridad"
                  (change)="aplicarFiltro('prioridad', $any($event.target).value)">
            <option value="">Todas las prioridades</option>
            @for (prioridad of prioridades(); track prioridad) {
              <option [value]="prioridad">{{ prioridad }}</option>
            }
          </select>
        </div>
      </div>

      @if (filtros().search || filtros().estado || filtros().prioridad) {
        <div class="active-filters">
          <span class="filters-label">Filtros activos:</span>
          @if (filtros().search) {
            <span class="filter-badge">
              Búsqueda: "{{ filtros().search }}"
              <i class="bi bi-x" (click)="aplicarFiltro('search', '')"></i>
            </span>
          }
          @if (filtros().estado) {
            <span class="filter-badge">
              Estado: {{ filtros().estado }}
              <i class="bi bi-x" (click)="aplicarFiltro('estado', '')"></i>
            </span>
          }
          @if (filtros().prioridad) {
            <span class="filter-badge">
              Prioridad: {{ filtros().prioridad }}
              <i class="bi bi-x" (click)="aplicarFiltro('prioridad', '')"></i>
            </span>
          }
        </div>
      }
    </div>
  </div>

  <div class="main-card">
    <div class="card-header">
      <div class="card-header-content">
        <div>
          <h2 class="card-title">
            <i class="bi bi-list-ul"></i>
            Historial
          </h2>
          <p class="card-subtitle">
            Mostrando {{ tickets().length }} de {{ paginacion().totalItems }} tickets
          </p>
        </div>
        <div class="header-controls">
          <div class="items-per-page">
            <label>Mostrar:</label>
            <select class="form-select small" 
                    [value]="paginacion().itemsPerPage"
                    (change)="cambiarItemsPorPagina($event)">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body">
      @if (isLoading()) {
        <div class="loading-state">
          <div class="spinner-container">
            <div class="spinner"></div>
            <p>Cargando tus tickets...</p>
          </div>
        </div>
      } @else {
        @if (tickets().length > 0) {
          <div class="table-container">
            <table class="modern-table">
              <thead class="table-header">
                <tr>
                  <th scope="col" class="ps-4 sortable" (click)="cambiarOrden('consecutivo')">
                    Ticket
                    <i class="bi ms-1" [ngClass]="getOrdenIcon('consecutivo')"></i>
                  </th>
                  <th scope="col">Categoría</th>
                  <th scope="col" class="sortable" (click)="cambiarOrden('estado')">
                    Estado
                    <i class="bi ms-1" [ngClass]="getOrdenIcon('estado')"></i>
                  </th>
                  <th scope="col" class="sortable" (click)="cambiarOrden('prioridad')">
                    Prioridad
                    <i class="bi ms-1" [ngClass]="getOrdenIcon('prioridad')"></i>
                  </th>
                  <th scope="col" class="sortable" (click)="cambiarOrden('fechaCreacion')">
                    Fecha Creación
                    <i class="bi ms-1" [ngClass]="getOrdenIcon('fechaCreacion')"></i>
                  </th>
                  <th scope="col" class="text-center pe-4">Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (ticket of tickets(); track ticket.id) {
                  <tr class="table-row">
                    <td class="ps-4">
                      <div class="ticket-info">
                        <div class="ticket-code">{{ ticket.consecutivo }}</div>
                        <div class="ticket-title">{{ ticket.titulo }}</div>
                      </div>
                    </td>

                    <td>
                      <span class="category-name">{{ ticket.categoria?.nombre }}</span>
                    </td>

                    <td>
                      <span class="badge" [ngClass]="getEstadoBadgeClass(ticket.estado)">
                        <i class="bi me-1" [ngClass]="getEstadoIcon(ticket.estado)"></i>
                        {{ ticket.estado }}
                      </span>
                    </td>

                    <td>
                      <span class="badge" [ngClass]="getPrioridadBadgeClass(ticket.prioridad)">
                        {{ ticket.prioridad }}
                      </span>
                    </td>

                    <td>
                      {{ ticket.fechaCreacion | date:'dd/MM/yyyy' }}
                    </td>

                    <td class="text-center pe-4">
                      <div class="action-buttons">
                        <button class="btn-icon info" (click)="viewTicketDetail(ticket)" title="Ver detalle">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <div class="pagination-container">
            <div class="pagination-info">
              Página {{ paginacion().currentPage }} de {{ paginacion().totalPages }} • 
              {{ paginacion().totalItems }} tickets en total
            </div>
            <nav class="pagination">
              <button class="pagination-btn" 
                      [disabled]="!paginacion().hasPrevPage"
                      (click)="cambiarPagina(paginacion().currentPage - 1)">
                <i class="bi bi-chevron-left"></i> Anterior
              </button>
              
              <div class="pagination-pages">
                @for (page of getPaginationPages(); track page) {
                  @if (page === '...') {
                    <span class="pagination-ellipsis">...</span>
                  } @else {
                    <button class="pagination-page" 
                            [class.active]="page === paginacion().currentPage"
                            (click)="cambiarPagina(page)">
                      {{ page }}
                    </button>
                  }
                }
              </div>

              <button class="pagination-btn" 
                      [disabled]="!paginacion().hasNextPage"
                      (click)="cambiarPagina(paginacion().currentPage + 1)">
                Siguiente <i class="bi bi-chevron-right"></i>
              </button>
            </nav>
          </div>

        } @else {
          <div class="empty-state">
            <div class="empty-content">
              <i class="bi bi-search empty-icon"></i>
              <h3>No se encontraron tickets</h3>
              <p>
                No hay tickets que coincidan con los filtros aplicados.
                @if (filtros().search || filtros().estado || filtros().prioridad) {
                  <br>
                  <small>Intenta ajustar los filtros de búsqueda.</small>
                }
              </p>
              <button class="btn-action primary" (click)="limpiarFiltros()">
                <i class="bi bi-arrow-clockwise"></i>
                Limpiar Filtros
              </button>
            </div>
          </div>
        }
      }
    </div>
  </div>
</div>

@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
      <div class="modal-header viewing">
        <div class="modal-title">
          <i class="bi bi-ticket-perforated"></i>
          <div>
            <h3>Detalle del Ticket</h3>
          </div>
        </div>
        <button class="btn-close" (click)="closeModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      @if (selectedTicket()) {
        <div class="modal-body">
          <div class="ticket-header">
            <div class="ticket-avatar">
              <i class="fas fa-ticket-alt"></i>
            </div>
            
            <div class="ticket-info">
              <h2>{{ selectedTicket()!.consecutivo }}</h2>
              <h4 class="ticket-title">{{ selectedTicket()!.titulo }}</h4>
              <div class="ticket-badges">
                <span class="badge primary">
                  <i class="bi me-1" [ngClass]="getEstadoIcon(selectedTicket()!.estado)"></i>
                  {{ selectedTicket()!.estado }}
                </span>
                <span class="badge" [ngClass]="getPrioridadBadgeClass(selectedTicket()!.prioridad)">
                  {{ selectedTicket()!.prioridad }}
                </span>
              </div>
            </div>
          </div>

<div class="modal-section">
  <div class="section-card">
    <div class="section-header">
      <i class="bi bi-info-circle"></i>
      <h4>Información Básica</h4>
    </div>
    <div class="section-body centered-info">
      <div class="info-grid centered-layout">
    
        <div class="info-item centered description-single-line">
                   <i class="bi bi-text-paragraph"></i>
          <label>Descripción</label>
          <div class="info-value">
            <span class="description-text">{{ selectedTicket()!.descripcion }}</span>
          </div>
        </div>

        <div class="info-row">
          @if (selectedTicket()!.tecnicoAsignado) {
            <div class="info-item centered">
              <label>Técnico Asignado</label>
              <div class="info-value">
                <i class="bi bi-person-check"></i>
                <div class="user-info">
                  <div class="user-name">{{ selectedTicket()!.tecnicoAsignado.nombre }}</div>
                  <div class="user-email">{{ selectedTicket()!.tecnicoAsignado.correo }}</div>
                </div>
              </div>
            </div>
          }

          <div class="info-item centered">
            <label>Categoría</label>
            <div class="info-value">
              <i class="bi bi-tag"></i>
              <span>{{ selectedTicket()!.categoria?.nombre }}</span>
            </div>
          </div>

          <div class="info-item centered">
            <label>Tiempo de Respuesta</label>
            <div class="info-value">
              <i class="bi bi-alarm"></i>
              <span>{{ selectedTicket()!.slaRespuesta }} minutos</span>

            </div>
          </div>
        </div>

        <div class="info-row dates-row">
          <div class="info-item centered">
            <label>Fecha de Creación</label>
            <div class="info-value">
              <i class="bi bi-calendar"></i>
              <span>{{ selectedTicket()!.fechaCreacion | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>

          <div class="info-item centered">
            <label>Última Actualización</label>
            <div class="info-value">
              <i class="bi bi-clock"></i>
              <span>{{ selectedTicket()!.fechaActualizacion | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@if (selectedTicket()!.imagenes && selectedTicket()!.imagenes.length > 0) {
  <div class="modal-section">
    <div class="section-card">
      <div class="section-header">
        <i class="bi bi-images"></i>
        <h4>Imágenes Adjuntas</h4>
        <span class="section-badge">{{ selectedTicket()!.imagenes.length }}</span>
      </div>
      <div class="section-body">
        <div class="images-grid">
          @for (imagen of selectedTicket()!.imagenes; track imagen.id) {
            <div class="image-card">
              <div class="image-content">
                <img 
                  [src]="getImageUrl(imagen.nombreArchivo || imagen.nombre)" 
                  [alt]="imagen.nombre || imagen.nombreArchivo" 
                  class="ticket-image" 
                  (click)="openImageModal(imagen)"
                  (error)="handleImageError($event)">
                <div class="image-info">
                  <p>{{ imagen.descripcion || 'Sin descripción' }}</p>
                  <small class="upload-date">{{ imagen.creadoEn | date:'dd/MM/yyyy' }}</small>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
}
          @if (selectedTicket()!.historial && selectedTicket()!.historial.length > 0) {
            <div class="modal-section">
              <div class="section-card">
                <div class="section-header">
                  <i class="bi bi-clock-history"></i>
                  <h4>Historial de Cambios</h4>
                  <span class="section-badge">{{ selectedTicket()!.historial.length }}</span>
                </div>
                <div class="section-body">
                  <div class="timeline">
                    @for (historial of selectedTicket()!.historial; track historial.id) {
                      <div class="timeline-item">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                          <div class="timeline-header">
                            <h6>
                              <i class="bi bi-arrow-right"></i>
                              {{ historial.estadoOrigen }} → {{ historial.estadoDestino }}
                            </h6>
                            <small>{{ historial.creadoEn | date:'dd/MM/yyyy' }}</small>
                          </div>
                          <p class="timeline-description">{{ historial.observaciones }}</p>
                          <small class="timeline-user">Por: {{ historial.usuario?.nombre }}</small>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          }

          <div class="modal-section">
            <div class="section-card">
              <div class="section-header">
                <i class="bi bi-star"></i>
                <h4>Valoración de Servicio</h4>
              </div>
              <div class="section-body">
                @if (selectedTicket()!.valoracion) {
                  <div class="rating-content">
                    <div class="rating-score">
                      <span class="score">{{ selectedTicket()!.valoracion.puntuacion }} / 5</span>
                      <div class="star-rating">
                        @for (star of [1,2,3,4,5]; track star) {
                          <i class="bi" [ngClass]="star <= selectedTicket()!.valoracion.puntuacion ? 'bi-star-fill text-warning' : 'bi-star'"></i>
                        }
                      </div>
                    </div>
                    <div class="rating-comment">
                      <p>{{ selectedTicket()!.valoracion.comentario || 'Sin comentarios' }}</p>
                     
                    </div>
                  </div>
                } @else {
                  <div class="empty-section">
                    <i class="bi bi-star"></i>
                    <p>No hay valoración</p>
                    <small>Este ticket no ha sido valorado aún.</small>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      }

      <div class="modal-footer">
        <button type="button" class="btn-action secondary" (click)="closeModal()">
          <i class="bi bi-x-circle"></i>
          Cerrar
        </button>
      </div>
    </div>
  </div>
}

@if (showImageModal()) {
  <div class="image-modal-overlay" (click)="closeImageModal()">
    <div class="image-modal-container" (click)="$event.stopPropagation()">
      <div class="image-modal-header">
        <div class="image-info">
          <h3>{{ selectedImage()?.nombre || selectedImage()?.nombreArchivo }}</h3>
          <p>{{ selectedImage()?.descripcion || 'Sin descripción' }}</p>
          <small>{{ selectedImage()?.creadoEn | date:'dd/MM/yyyy' }}</small>
        </div>
        <div class="image-actions">
          <button class="btn-action" (click)="closeImageModal()" title="Cerrar">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>
      <div class="image-modal-content">
        <button class="nav-button prev" (click)="navigateImage('prev')" [disabled]="(selectedTicket()?.imagenes?.length || 0) <= 1">
          <i class="bi bi-chevron-left"></i>
        </button>
        
        <div class="image-wrapper">
          <img 
            [src]="getImageUrl(selectedImage()?.nombreArchivo || selectedImage()?.nombre)" 
            [alt]="selectedImage()?.nombre || selectedImage()?.nombreArchivo" 
            class="full-size-image"
            (error)="handleImageError($event)">
        </div>

        <button class="nav-button next" (click)="navigateImage('next')" [disabled]="(selectedTicket()?.imagenes?.length || 0) <= 1">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      <div class="image-modal-footer">
        <div class="image-counter">
          {{ currentImageIndex() + 1 }} / {{ selectedTicket()?.imagenes?.length || 0 }}
        </div>
      </div>
    </div>
  </div>
}