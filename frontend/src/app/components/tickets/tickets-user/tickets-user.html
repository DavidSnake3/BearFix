<div class="tickets-container">
  <div class="tickets-header">
    <div class="header-content">
      <div class="info-row">
        <div class="header-info">
          <h1 class="page-title">
            <i class="bi bi-ticket-perforated"></i>
            {{'Creación de Tiquetes' | transloco}}
          </h1>
          <p class="page-subtitle">{{'Creación de tiquetes por parte de los usuarios' | transloco}}</p>
        </div>
      </div>
      
      <div class="info-row form-group">
        <button type="button" class="btn-action primary" (click)="createTicket()" 
          [disabled]="!newTicket().titulo || !newTicket().categoriaId || !newTicket().etiquetaId">
          <i class="bi bi-check-circle"></i>
          {{'Crear Tiquete' | transloco}}
        </button>
      </div>

      <div class="card-body">
        <div class="create-ticket-form">
          <div class="modal-grid">
            <div class="modal-section">
              <div class="section-card equal-height">
                <div class="section-header">
                  <i class="bi bi-info-circle"></i>
                  <h4>{{'Información del Ticket' | transloco}}</h4>
                </div>
                <div class="section-body">
                  <div class="info-grid">
                    <div class="info-item full-width">
                      <label class="form-label required">{{'Título' | transloco}}</label>
                      <input type="text" class="form-input" [(ngModel)]="newTicket().titulo" placeholder="{{'Ingrese el título del ticket' | transloco}}">
                    </div>

                    <div class="info-item full-width">
                      <label class="form-label">{{'Descripción' | transloco}}</label>
                      <textarea class="form-textarea" rows="3" [(ngModel)]="newTicket().descripcion" placeholder="{{'Describa el problema o solicitud' | transloco}}"></textarea>
                    </div>

                    <div class="info-row">
                      <div class="info-item">
                        <label class="form-label required">{{'Etiqueta' | transloco}}</label>
                        <select class="form-select" [(ngModel)]="newTicket().etiquetaId" 
                                (change)="onEtiquetaChange($any($event.target).value)">
                          <option value="">{{'Seleccione etiqueta' | transloco}}</option>
                          @for (etiqueta of etiquetasConCategoria(); track etiqueta.id) {
                          <option [value]="etiqueta.id">{{ etiqueta.nombre }}</option>
                          }
                        </select>
                      </div>

                      <div class="info-item">
                        <label class="form-label required">{{'Categoría (Automática)' | transloco}}</label>
                        <div class="categoria-display">
                          @if (categoriaSeleccionada()) {
                            <div class="categoria-info">
                              <strong>{{ categoriaSeleccionada().nombre }}</strong>
                              <small class="text-muted">{{ categoriaSeleccionada().descripcion }}</small>
                            </div>
                          } @else {
                            <div class="categoria-placeholder">
                              <span class="text-muted">{{'Seleccione una etiqueta para ver la categoría' | transloco}}</span>
                            </div>
                          }
                        </div>
                      </div>
                    </div>

                    <div class="info-row">
                      <div class="info-item">
                        <label class="form-label required">{{'Prioridad' | transloco}}</label>
                        <select class="form-select" [(ngModel)]="newTicket().prioridad">
                          <option value="">{{'Seleccione prioridad' | transloco}}</option>
                          @for (prioridad of prioridadesList(); track prioridad) {
                          <option [value]="prioridad">{{ prioridad | transloco}}</option>
                          }
                        </select>
                      </div>

                      <div class="info-item">
                        <label class="form-label">{{'Usuario Solicitante' | transloco}}</label>
                        <div class="user-select-container">
                          @for (usuario of usuariosList(); track usuario.id) {
                            <div class="user-info">
                              <input type="text" value="{{ usuario.nombre }}" class="form-input" disabled>
                            </div>
                          }
                        </div>
                      </div>
                    </div>

                    <!-- CORREGIDO: Sección de imágenes mejorada -->
                    <div class="info-item full-width">
                      <label class="form-label">{{'Imágenes Adjuntas' | transloco}}</label>
                      <div class="file-upload-container">
                        <input type="file" 
                               #fileInput 
                               (change)="onFileSelected($event)" 
                               multiple 
                               accept="image/*" 
                               class="file-input"
                               [disabled]="estaSubiendoImagen()">
                        <div class="upload-area" (click)="fileInput.click()">
                          <i class="bi bi-cloud-upload"></i>
                          <p>{{'Haz clic o arrastra imágenes aquí' | transloco}}</p>
                          <small>{{'Formatos: JPEG, PNG, GIF, WebP (Máx. 2MB por imagen)' | transloco}}</small>
                        </div>
                      </div>
                      
                      @if (estaSubiendoImagen()) {
                      <div class="upload-loading">
                        <div class="spinner small"></div>
                        <span>{{'Subiendo imagen...' | transloco}}</span>
                      </div>
                      }
                    </div>

                    @if (imagenesSeleccionadas().length > 0) {
                    <div class="info-item full-width">
                      <div class="images-preview">
                        <h5>{{'Imágenes a subir:' | transloco}}</h5>
                        <div class="preview-grid">
                          @for (imagen of imagenesSeleccionadas(); track $index; let i = $index) {
                          <div class="preview-item">
                            <img [src]="imagen.url" [alt]="imagen.descripcion" class="preview-image">
                            <div class="preview-actions">
                              <button class="btn-icon danger small" 
                                      (click)="eliminarImagenSeleccionada(i, imagen)"
                                      title="Eliminar imagen">
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                          </div>
                          }
                        </div>
                      </div>
                    </div>
                    }
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-section">
              <div class="section-card equal-height">
                <div class="section-header">
                  <i class="bi bi-person"></i>
                  <h4>{{'Información del Sistema' | transloco}}</h4>
                </div>
                <div class="section-body">
                  @for (usuario of usuariosList(); track usuario.id) {
                  <div class="user-info-display">
                    <h5>{{'Usuario Seleccionado' | transloco}}</h5>
                    <div class="info-row">
                      <div class="info-item">
                        <label>{{'Nombre' | transloco}}</label>
                        <div class="info-value">{{ usuario.nombre }}</div>
                      </div>
                      <div class="info-item">
                        <label>{{'Correo' | transloco}}</label>
                        <div class="info-value">{{ usuario.correo }}</div>
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-item">
                        <label>{{'Rol' | transloco}}</label>
                        <div class="info-value">{{ usuario.rol }}</div>
                      </div>
                    </div>
                  </div>
                  }

                  <div class="dates-info">
                    <div class="info-row">
                      <div class="date-item">
                        <label>{{'Fecha de Creación' | transloco}}</label>
                        <div class="date-value">
                          <i class="bi bi-calendar"></i>
                          <span>{{ today | date:'dd/MM/yyyy HH:mm' }}</span>
                        </div>
                      </div>

                      <div class="date-item">
                        <label>{{'Estado Inicial' | transloco}}</label>
                        <div class="date-value">
                          <i class="bi bi-clock"></i>
                          <span>{{'PENDIENTE' | transloco}}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>